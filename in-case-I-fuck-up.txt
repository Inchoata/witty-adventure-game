import pygame
from menu import MainMenu, OptionsMenu, CreditsMenu
import time

class Game():
    def __init__(self):
        pygame.init()
        self.running = True # When the application is running
        self.playing = False # When the game is actually being played
        self.UP_KEY, self.DOWN_KEY, self.START_KEY, self.BACK_KEY = False, False, False, False # START_KEY = ENTER
        self.I_KEY = False
        self.DISPLAY_H = 600
        self.DISPLAY_W = 600
        self.mid_width = self.DISPLAY_W/2
        self.mid_height = self.DISPLAY_H/2

        #Initialise window
        self.window = pygame.display.set_mode((self.DISPLAY_W, self.DISPLAY_H))
        pygame.display.set_caption("SOME COOL GAME NAME")
        self.display = pygame.Surface((self.window.get_size()))
        self.font = pygame.font.SysFont("Courier", 20)
        self.BLACK = (0,0,0)
        self.GREEN = (0,255,0)

        self.main_menu = MainMenu(self)
        self.options_menu = OptionsMenu(self)
        self.credits_menu = CreditsMenu(self)
        self.curr_menu = self.main_menu
        self.current_level = 0
        self.text_complete = False
        # Current menu. Self (current Game instance) given as parameter as MainMenu requires a game to be passed in.

    def game_loop(self):
        while self.playing:
            self.events()
            if self.START_KEY:
                self.playing = False
            self.reset_keys()
            self.new_game()

    def draw_text(self, text, size, position):
        text_font = pygame.font.SysFont("Courier", size)
        text_surface = text_font.render(text, True, self.GREEN)
        text_rect = text_surface.get_rect()
        text_rect.center = position
        self.display.blit(text_surface, text_rect)
        my_text = text_surface.convert_alpha()
        return my_text

    def events(self):
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                self.running, self.playing = False, False
                self.curr_menu.run_display = False
                self.current_level = 0
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_RETURN:
                    self.START_KEY = True
                if event.key == pygame.K_BACKSPACE:
                    self.BACK_KEY = True
                if event.key == pygame.K_UP:
                    self.UP_KEY = True
                if event.key == pygame.K_DOWN:
                    self.DOWN_KEY = True
                if event.key == pygame.K_i:
                    self.I_KEY = True

    def reset_keys(self):
        self.UP_KEY, self.DOWN_KEY, self.START_KEY, self.BACK_KEY = False, False, False, False

    def split(self, word):
        return[char for char in word]

    def display_text_animation(self, text, w_pos, h_pos):
        for line in text:
            for letter in self.split(line):
                self.check_input()
                self.draw_text(letter, 18, (w_pos, h_pos))
                self.window.blit(self.display, (0, 0))
                pygame.display.update()
                pygame.time.wait(10)
                w_pos += 10
            w_pos = 50
            h_pos += 30
        self.text_complete = True
        return self.text_complete

    def display_text_block(self, text, w_pos, h_pos):
        for line in text:
            for letter in self.split(line):
                self.draw_text(letter, 18, (w_pos, h_pos))
                w_pos += 10
            w_pos = 50
            h_pos += 30
        self.window.blit(self.display, (0, 0))
        pygame.display.update()


    def check_input(self): # TO DO: FIX INPUTS
        #self.reset_keys()
        if self.START_KEY:
            #self.playing = True
            self.current_level = 0
            self.curr_menu = self.main_menu
        elif self.I_KEY:
            print("I should show the inventory.")
            self.current_level = 0
            self.curr_menu = self.main_menu


    def reset_screen(self):
        self.display.fill(self.BLACK)
        self.window.blit(self.display, (0, 0))
        pygame.display.update()
        self.reset_keys()

    def display_action_block(self, options): # This is a horrendous method, refactor later!
        x_pos = (self.DISPLAY_W / 10)
        y_pos = 3 * (self.DISPLAY_H / 5) # x and y of box top left
        width = ((self.DISPLAY_W / 10) * 8)
        height = ((self.DISPLAY_H / 3) - 30)
        box = pygame.draw.rect(self.display, self.GREEN, (x_pos, y_pos, width, height), 1)
        text_y_pos = y_pos + 20
        text_x_pos = (x_pos + 20)
        for option in options:
            text_font = pygame.font.SysFont("Courier", 16)
            text_surface = text_font.render(option, True, self.GREEN)
            text_rect = text_surface.get_rect()
            text_rect.midleft = (text_x_pos, text_y_pos)
            self.display.blit(text_surface, text_rect)
            text_y_pos += (height/4)

    def new_game(self):
        self.playing = False # the game is playing but needed to get game loop to stop running. change this later
        self.reset_screen()
        self.current_level = 1

        while self.current_level:
            self.reset_keys()
            self.events()
            self.check_input()
            # Initialise game variables

            opening_text = ["You awaken, head pounding. There is a bright light",
                            "shining onto your face. You open your eyes. You're",
                            "alone in a bright, clinical room. You are tied to a",
                            "surgical operating table. There are surgical ",
                            "instruments on a table beside you. It looks like you",
                            "could lean over and reach the tools with your mouth.",
                            "What will you do?"]

            options =      ["A) Cry for help.",
                            "B) Attempt to lean over to reach a scalpel ",
                            "   with your mouth.",
                            "C) Look around."]
            controls =      "I - Inventory         M - Map       ENTER - Main Menu"

            if self.text_complete:
                self.display_text_block(opening_text, 50, 20)
                self.display_action_block(options)
                self.draw_text(controls, 14, (self.mid_width, self.DISPLAY_H-20))
            else:
                self.text_complete = self.display_text_animation(opening_text, 50, 20)





